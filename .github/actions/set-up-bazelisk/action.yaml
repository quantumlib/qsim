# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Set up Bazelisk with caching
description: Installs Bazelisk and sets up multiple caches for Bazel

# Summary: reusable workflow to install Bazelisk (for Bazel) and set up Bazel
# caches. It grew out of trouble getting the existing bazel-contrib/setup-bazel
# action (from the GitHub Marketplace) to work with Netkos' "act".

inputs:
  debug:
    description: 'Run with debugging options'
    type: boolean
    required: false
    default: true
  bazel-version:
    description: 'Version of Bazel to use:'
    type: string
    required: false
    default: ''

permissions:
  actions: write
  contents: read

env:
  debug: ${{inputs.debug || runner.debug}}
  bazel-cache: ~/.cache/bazel

runs:
  using: 'composite'
  steps:
    - name: Set environment variables
      shell: bash
      SHELLOPTS: ${{env.debug && 'xtrace' || ''}}
      run: |
        version=""
        if [[ -n "${{inputs.bazel-version}}" ]]; then
          version="${{inputs.bazel-version}}"
        elif [[ -f ".bazelversion" ]]; then
          version="$(cat .bazelversion | tr -d ' \n\r')"
        else
          echo "::error::Bazel version has not been specified."
          exit 1
        fi
        echo "bazelversion=${version}" >> "$GITHUB_ENV"

    - name: Install Bazelisk
      env:
        BAZELISK_SHOW_PROGRESS: ${{env.debug}}
      shell: bash
      run: npm install @bazel/bazelisk

    # Explanation of the following caches:
    #
    # Bazelisk cache: stores copies of Bazel downloaded by Bazelisk. The copies
    # are stored in subdirs coded by hash numbers, and thus this cache can be
    # shared between workflows.
    #
    # Bazel --repository_cache: stores the raw downloaded files (like .zip,
    # .tar.gz) specified by repository rules like http_archive. This can also
    # be shared between workflows.
    #
    # Bazel --disk_cache: stores the compiled outputs of build actions, such as
    # compiled object files (.o), linked libraries (.so, .dll), binaries, & test
    # results. This is also sharable between workflows.

    - name: Set up cache for Bazelisk
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830  # v4.3.0
      with:
        # Bazelisk doesn't have an option to control this cache location.
        path: ~/.cache/bazelisk
        key: bazelisk-cache

    - name: Set up Bazel repository cache
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830  # v4.3.0
      with:
        path: ${{env.bazel-cache}}/repository_cache
        key: bazel-repo-${{env.bazelversion}}
        restore-keys: bazel-repo-

    - name: Set up Bazel disk cache
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830  # v4.3.0
      with:
        path: ${{env.bazel-cache}}/disk_cache
        key: bazel-disk-${{runner.os}}-${{runner.arch}}-${{github.ref}}-${{github.sha}}
        restore-keys: bazel-disk-${{runner.os}}-${{runner.arch}}-${{github.ref}}-

    - name: Determine the number of processors we can use
      shell: bash
      run: |
        if [[ "${{startsWith(runner.os, 'win')}}" == "true" ]]; then
          echo "num_cpus=${NUMBER_OF_PROCESSORS}" >> "$GITHUB_ENV"
        else
          echo "num_cpus=$(getconf _NPROCESSORS_ONLN)" >> "$GITHUB_ENV"
        fi

    - name: Add configuration settings to .bazelrc
      shell: bash
      run: |
        {
        echo "startup --output_base=${{env.bazel-cache}}/output_base"
        echo "build --disk_cache=${{env.bazel-cache}}/disk_cache"
        echo "build --repository_cache=${{env.bazel-cache}}/repository_cache"
        echo "build --jobs=${{env.num_cpus}}"
        echo "test --cache_test_results=no"
        } >> .bazelrc

    - name: Print configuration information
      if: env.debug
      shell: bash
      run: |
        bazelisk --version
        echo "::group::Contents of .bazelversion"
        cat .bazelversion
        echo "::endgroup::"
        echo "::group::Contents of .bazelrc"
        cat .bazelrc
        echo "::endgroup::"
        echo "::group::GitHub context"
        echo "The job_id is: $GITHUB_JOB"
        echo "The id of this action is: $GITHUB_ACTION"
        echo "The run id is: $GITHUB_RUN_ID"
        echo "GitHub SHA: $GITHUB_SHA"
        echo "::endgroup::"
